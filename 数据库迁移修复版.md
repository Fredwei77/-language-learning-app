# ğŸ—„ï¸ æ•°æ®åº“è¿ç§» - ä¿®å¤ç‰ˆ

## âŒ ä¹‹å‰çš„é”™è¯¯

é”™è¯¯ä¿¡æ¯ï¼š`relation "users" does not exist`

**åŸå› ï¼š** Supabase Auth ä½¿ç”¨çš„æ˜¯ `auth.users` è¡¨ï¼Œä¸æ˜¯ `public.users` è¡¨ã€‚

## âœ… æ–°çš„è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ç®€åŒ–ç‰ˆè„šæœ¬ï¼Œä¸ä¾èµ– users è¡¨ã€‚

## ğŸ“ æ‰§è¡Œæ­¥éª¤

### 1. æ‰“å¼€ Supabase SQL Editor

1. è®¿é—®ï¼šhttps://supabase.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. å·¦ä¾§èœå• â†’ **SQL Editor**
4. ç‚¹å‡» **"New query"**

### 2. å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹ SQL

```sql
-- ç®€åŒ–ç‰ˆå¾®ä¿¡æ³¨å†Œè¡¨åˆ›å»ºè„šæœ¬

-- åˆ›å»ºä¸´æ—¶æ³¨å†Œè¡¨
CREATE TABLE IF NOT EXISTS pending_registrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scene_id VARCHAR(64) UNIQUE NOT NULL,
  email VARCHAR(255) NOT NULL,
  password_hash TEXT NOT NULL,
  nickname VARCHAR(100),
  wechat_openid VARCHAR(100),
  status VARCHAR(20) DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() + INTERVAL '30 minutes',
  completed_at TIMESTAMP WITH TIME ZONE,
  
  CONSTRAINT check_status CHECK (status IN ('pending', 'completed', 'expired', 'failed'))
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_pending_scene_id ON pending_registrations(scene_id);
CREATE INDEX IF NOT EXISTS idx_pending_status ON pending_registrations(status);
CREATE INDEX IF NOT EXISTS idx_pending_expires_at ON pending_registrations(expires_at);
CREATE INDEX IF NOT EXISTS idx_pending_wechat_openid ON pending_registrations(wechat_openid);

-- æ·»åŠ æ³¨é‡Š
COMMENT ON TABLE pending_registrations IS 'ä¸´æ—¶æ³¨å†Œè¡¨ï¼Œç”¨äºå¾®ä¿¡å…¬ä¼—å·æ³¨å†ŒéªŒè¯';
COMMENT ON COLUMN pending_registrations.scene_id IS 'äºŒç»´ç åœºæ™¯å€¼';
COMMENT ON COLUMN pending_registrations.wechat_openid IS 'å¾®ä¿¡ç”¨æˆ· OpenID';
COMMENT ON COLUMN pending_registrations.status IS 'çŠ¶æ€ï¼špending-ç­‰å¾…ä¸­, completed-å·²å®Œæˆ, expired-å·²è¿‡æœŸ, failed-å¤±è´¥';

-- åˆ›å»ºæ¸…ç†è¿‡æœŸè®°å½•çš„å‡½æ•°
CREATE OR REPLACE FUNCTION clean_expired_registrations()
RETURNS void AS $$
BEGIN
  UPDATE pending_registrations
  SET status = 'expired'
  WHERE status = 'pending'
    AND expires_at < NOW();
END;
$$ LANGUAGE plpgsql;

-- éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ
SELECT 'pending_registrations è¡¨åˆ›å»ºæˆåŠŸ' AS message;
```

### 3. ç‚¹å‡» "Run" æŒ‰é’®

æ‰§è¡Œ SQL è„šæœ¬

### 4. éªŒè¯æˆåŠŸ

åº”è¯¥çœ‹åˆ°ï¼š
```
pending_registrations è¡¨åˆ›å»ºæˆåŠŸ
```

### 5. æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»º

1. å·¦ä¾§èœå• â†’ **Table Editor**
2. åº”è¯¥èƒ½çœ‹åˆ° `pending_registrations` è¡¨
3. ç‚¹å‡»è¡¨åæŸ¥çœ‹ç»“æ„

## âœ… æˆåŠŸæ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼Œè¯´æ˜æˆåŠŸï¼š
- âœ… æ˜¾ç¤º "pending_registrations è¡¨åˆ›å»ºæˆåŠŸ"
- âœ… Table Editor ä¸­èƒ½çœ‹åˆ°æ–°è¡¨
- âœ… è¡¨ä¸­æœ‰ä»¥ä¸‹å­—æ®µï¼š
  - id
  - scene_id
  - email
  - password_hash
  - nickname
  - wechat_openid
  - status
  - created_at
  - expires_at
  - completed_at

## ğŸ“¸ æˆåŠŸæˆªå›¾ç¤ºä¾‹

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æœï¼š

```
Results
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ message                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pending_registrations è¡¨åˆ›å»ºæˆåŠŸ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## â“ å¦‚æœè¿˜æ˜¯å¤±è´¥

è¯·æˆªå›¾é”™è¯¯ä¿¡æ¯ç»™æˆ‘ï¼ŒåŒ…æ‹¬ï¼š
1. é”™è¯¯æç¤ºçš„å®Œæ•´æ–‡æœ¬
2. SQL Editor çš„æˆªå›¾

## âœ… å®Œæˆå

å‘Šè¯‰æˆ‘ï¼š
```
âœ… æ•°æ®åº“è¿ç§»æˆåŠŸå®Œæˆ
```

ç„¶åç»§ç»­é…ç½® Netlify ç¯å¢ƒå˜é‡ã€‚

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** éšæ—¶æˆªå›¾ç»™æˆ‘ï¼
