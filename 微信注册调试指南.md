# 微信注册调试指南

## 🔍 当前问题

注册失败，显示"创建注册记录失败"

## 🛠️ 立即修复

### 步骤 1：修复数据库权限

在 Supabase SQL Editor 中执行以下 SQL：

```sql
-- 修复 pending_registrations 表的 RLS 策略
-- 允许匿名用户插入记录

-- 启用 RLS
ALTER TABLE pending_registrations ENABLE ROW LEVEL SECURITY;

-- 删除现有策略（如果有）
DROP POLICY IF EXISTS "Allow anonymous insert" ON pending_registrations;
DROP POLICY IF EXISTS "Allow public insert" ON pending_registrations;
DROP POLICY IF EXISTS "Allow service role all" ON pending_registrations;

-- 创建新策略：允许所有人插入
CREATE POLICY "Allow anonymous insert"
ON pending_registrations
FOR INSERT
TO anon
WITH CHECK (true);

-- 创建策略：允许所有人查询
CREATE POLICY "Allow select own records"
ON pending_registrations
FOR SELECT
TO anon
USING (true);

-- 创建策略：允许所有人更新
CREATE POLICY "Allow update own records"
ON pending_registrations
FOR UPDATE
TO anon
USING (true)
WITH CHECK (true);
```

### 步骤 2：验证策略

执行以下查询验证策略是否创建成功：

```sql
SELECT schemaname, tablename, policyname, permissive, roles, cmd
FROM pg_policies
WHERE tablename = 'pending_registrations';
```

应该看到 3 个策略：
- Allow anonymous insert
- Allow select own records
- Allow update own records

### 步骤 3：重新测试

1. 访问：`https://good2study.netlify.app/auth/register-wechat`
2. 填写注册信息
3. 点击"下一步：扫码关注"
4. 应该能看到二维码了

## 🔍 如果还是失败

### 查看浏览器 Console

1. 按 F12 打开开发者工具
2. 切换到 Console 标签
3. 重新提交注册
4. 查看错误信息
5. 截图给我

### 查看 Network 请求

1. 在开发者工具中切换到 Network 标签
2. 重新提交注册
3. 找到 `register-wechat` 请求
4. 查看 Response
5. 截图给我

## 📊 可能的错误原因

### 1. RLS 策略问题
- 表启用了 RLS 但没有策略
- 策略不允许匿名用户插入

**解决：** 执行上面的 SQL

### 2. 环境变量问题
- WECHAT_APP_ID 或 WECHAT_APP_SECRET 错误
- 微信 API 调用失败

**检查：** Netlify 环境变量是否正确

### 3. 微信 API 问题
- Access Token 获取失败
- 二维码生成失败

**检查：** 微信公众号配置是否正确

## 🎯 快速诊断

### 测试数据库连接

在 Supabase SQL Editor 中执行：

```sql
-- 测试插入
INSERT INTO pending_registrations (
  scene_id,
  email,
  password_hash,
  nickname,
  status
) VALUES (
  'TEST_' || NOW()::text,
  'test@example.com',
  'test123',
  'Test User',
  'pending'
);

-- 查看结果
SELECT * FROM pending_registrations WHERE email = 'test@example.com';

-- 清理测试数据
DELETE FROM pending_registrations WHERE email = 'test@example.com';
```

如果这个测试失败，说明是数据库权限问题。

### 测试 API

在浏览器 Console 中执行：

```javascript
fetch('https://good2study.netlify.app/api/auth/register-wechat', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'test@example.com',
    password: 'Test123456',
    nickname: 'Test'
  })
})
.then(r => r.json())
.then(console.log)
.catch(console.error)
```

查看返回的错误信息。

## ✅ 完成后

执行 SQL 修复后，告诉我：

```
✅ SQL 执行成功，重新测试
```

---

**需要帮助？** 随时截图给我！
