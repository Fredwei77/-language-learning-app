# 微信注册功能部署指南

## 📋 部署前检查清单

在开始部署前，确保你已经完成：

- [ ] 已获取微信公众号 AppID
- [ ] 已获取微信公众号 AppSecret
- [ ] 已设置自定义 Token
- [ ] 已创建 `.env.local` 文件并填写配置
- [ ] 已在 Supabase 中执行数据库迁移脚本

## 🗄️ 步骤 1：配置数据库

### 1.1 登录 Supabase Dashboard

访问：https://supabase.com/dashboard

### 1.2 执行 SQL 脚本

1. 进入你的项目
2. 点击左侧 **SQL Editor**
3. 点击 **New query**
4. 复制 `scripts/create-wechat-registration-table.sql` 的内容
5. 粘贴并点击 **Run**

### 1.3 验证表创建成功

在 **Table Editor** 中应该能看到：
- `pending_registrations` 表
- `users` 表中新增了 `wechat_openid` 字段

## 🔧 步骤 2：配置环境变量

### 2.1 本地环境

确保 `.env.local` 文件包含：

```env
# 微信公众号配置
WECHAT_APP_ID=你的AppID
WECHAT_APP_SECRET=你的AppSecret
WECHAT_TOKEN=你的Token
NEXT_PUBLIC_WECHAT_NAME=忆迈AI智能文化

# Supabase 配置（应该已经有了）
NEXT_PUBLIC_SUPABASE_URL=你的Supabase URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的Supabase Key
```

### 2.2 Netlify 环境变量

1. 登录 Netlify Dashboard
2. 选择你的网站
3. 进入 **Site settings** → **Environment variables**
4. 添加以下变量：

```
WECHAT_APP_ID = 你的AppID
WECHAT_APP_SECRET = 你的AppSecret
WECHAT_TOKEN = 你的Token
NEXT_PUBLIC_WECHAT_NAME = 忆迈AI智能文化
```

⚠️ **注意：** `NEXT_PUBLIC_` 开头的变量会暴露给客户端，不要包含敏感信息！

## 📦 步骤 3：部署代码

### 3.1 提交代码

```bash
git add -A
git commit -m "添加微信注册功能"
git push origin main
```

### 3.2 等待部署

1. Netlify 会自动触发部署
2. 等待 2-3 分钟
3. 检查部署状态显示 "Published"

### 3.3 验证部署

访问：`https://good2study.netlify.app/api/wechat/callback`

应该看到：`Invalid signature` 或 `403` 错误（这是正常的，说明接口已部署）

## 🔗 步骤 4：配置微信服务器

### 4.1 登录微信公众平台

访问：https://mp.weixin.qq.com

### 4.2 进入服务器配置

```
左侧菜单 → 设置与开发 → 基本配置 → 服务器配置
```

### 4.3 填写配置信息

```
URL: https://good2study.netlify.app/api/wechat/callback
Token: [你在 .env.local 中设置的 Token]
EncodingAESKey: [点击"随机生成"按钮]
消息加解密方式: 明文模式
```

### 4.4 提交验证

1. 点击 **"提交"** 按钮
2. 微信会向你的服务器发送验证请求
3. 如果配置正确，会显示 **"提交成功"**

⚠️ **如果验证失败：**
- 检查 URL 是否正确
- 检查 Token 是否与代码中一致
- 查看 Netlify 的 Functions 日志

### 4.5 启用服务器配置

验证成功后，点击 **"启用"** 按钮

## 🧪 步骤 5：测试功能

### 5.1 访问注册页面

```
https://good2study.netlify.app/auth/register-wechat
```

### 5.2 填写注册信息

- 邮箱：使用测试邮箱
- 密码：至少6个字符
- 昵称：可选

### 5.3 扫码测试

1. 点击"下一步：扫码关注"
2. 应该看到二维码页面
3. 使用微信扫描二维码
4. 点击"关注公众号"

### 5.4 验证结果

**成功的情况：**
- 公众号发送注册成功消息
- 网页显示"注册成功"
- 3秒后自动跳转到登录页
- 可以使用注册的邮箱和密码登录

**失败的情况：**
- 查看下面的故障排除部分

## 🔍 步骤 6：查看日志

### 6.1 Netlify Functions 日志

1. Netlify Dashboard → Functions
2. 找到 `wechat-callback` 函数
3. 查看最近的调用日志

### 6.2 Supabase 日志

1. Supabase Dashboard → Logs
2. 查看数据库操作日志

### 6.3 浏览器控制台

按 F12 打开开发者工具，查看 Console 和 Network 标签

## ❌ 故障排除

### 问题 1：服务器配置验证失败

**可能原因：**
- URL 错误
- Token 不匹配
- 服务器未部署

**解决方案：**
1. 确认 URL 完全正确（包括 https://）
2. 确认 Token 与代码中一致
3. 访问 URL 确认接口可访问
4. 查看 Netlify 部署日志

### 问题 2：扫码后没有反应

**可能原因：**
- 服务器配置未启用
- 回调接口有错误
- 数据库连接问题

**解决方案：**
1. 确认服务器配置已启用
2. 查看 Netlify Functions 日志
3. 检查 Supabase 连接
4. 查看浏览器控制台错误

### 问题 3：显示"注册记录不存在"

**可能原因：**
- 二维码已过期
- 数据库写入失败
- sceneId 不匹配

**解决方案：**
1. 重新生成二维码
2. 检查数据库表是否创建成功
3. 查看 API 日志

### 问题 4：关注后收不到消息

**可能原因：**
- 消息发送失败
- 公众号权限不足
- 用户已屏蔽消息

**解决方案：**
1. 检查公众号是否有客服消息权限
2. 查看微信公众平台的消息日志
3. 确认用户未屏蔽公众号

## 📊 监控和维护

### 定期检查

1. **每周检查：**
   - 注册成功率
   - 错误日志
   - 数据库性能

2. **每月检查：**
   - 清理过期的临时注册记录
   - 更新 AppSecret（可选）
   - 检查 API 调用量

### 清理过期记录

在 Supabase SQL Editor 中执行：

```sql
SELECT clean_expired_registrations();
```

或者设置定时任务自动清理。

## 🎯 优化建议

### 1. 添加监控

使用 Sentry 或其他监控工具追踪错误

### 2. 添加统计

记录注册转化率、扫码率等数据

### 3. 优化用户体验

- 添加加载动画
- 优化二维码显示
- 添加帮助提示

### 4. 安全加固

- 添加请求频率限制
- 验证邮箱格式
- 防止重复注册

## ✅ 部署完成检查

完成部署后，确认以下都正常：

- [ ] 数据库表创建成功
- [ ] 环境变量配置正确
- [ ] 代码部署成功
- [ ] 微信服务器配置验证通过
- [ ] 测试注册流程成功
- [ ] 可以正常登录

## 📞 需要帮助？

如果遇到问题：

1. 查看本文档的故障排除部分
2. 检查 Netlify 和 Supabase 的日志
3. 截图错误信息
4. 提供详细的操作步骤

---

**预计部署时间：** 30-60 分钟  
**难度：** ⭐⭐⭐⭐☆  
**完成后：** 用户可以通过微信扫码快速注册！
