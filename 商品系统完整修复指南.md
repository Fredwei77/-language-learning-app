# ğŸ”§ å•†å“ç³»ç»Ÿå®Œæ•´ä¿®å¤æŒ‡å—

## é—®é¢˜æ€»ç»“
- âŒ ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼šBucket not found
- âŒ åˆ›å»ºå•†å“å¤±è´¥ï¼šè¡¨æœªæ‰¾åˆ°
- âŒ ç¼–è¾‘å•†å“å¤±è´¥ï¼šinvalid input syntax for type uuid

## âœ… å®Œæ•´ä¿®å¤æ­¥éª¤

### ç¬¬1æ­¥ï¼šåœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

æ‰“å¼€ Supabase Dashboard â†’ SQL Editor â†’ New query

å¤åˆ¶å¹¶æ‰§è¡Œ `scripts/COMPLETE-FIX-GIFTS.sql` æ–‡ä»¶ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. âœ… åˆ é™¤å¹¶é‡å»º gifts è¡¨
2. âœ… åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ç´¢å¼•
3. âœ… å¯ç”¨ RLS å¹¶åˆ›å»ºç­–ç•¥
4. âœ… åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨
5. âœ… æ’å…¥æµ‹è¯•æ•°æ®

æ‰§è¡Œååº”è¯¥çœ‹åˆ°ï¼š
```
âœ… gifts è¡¨åˆ›å»ºæˆåŠŸï¼
å•†å“æ•°é‡: 1

âœ… RLS ç­–ç•¥åˆ—è¡¨
- authenticated_delete
- authenticated_insert
- authenticated_read_all
- authenticated_update
- public_read_active

âœ… æµ‹è¯•æ•°æ®
id: [UUID]
name_zh: æµ‹è¯•å•†å“
coins: 100
stock: 999
is_active: true
```

### ç¬¬2æ­¥ï¼šåˆ›å»º Storage Bucket

#### æ–¹æ³•1ï¼šåœ¨ Dashboard ä¸­åˆ›å»ºï¼ˆæ¨èï¼‰

1. Supabase Dashboard â†’ Storage
2. ç‚¹å‡» "New bucket"
3. å¡«å†™ï¼š
   - Name: `gift-images`
   - Public bucket: âœ… å‹¾é€‰
   - File size limit: `5242880` (5MB)
4. ç‚¹å‡» "Create bucket"

#### æ–¹æ³•2ï¼šä½¿ç”¨ SQL

åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- åˆ›å»º bucket
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'gift-images',
  'gift-images',
  true,
  5242880,
  ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif']
)
ON CONFLICT (id) DO UPDATE
SET public = true, file_size_limit = 5242880;
```

### ç¬¬3æ­¥ï¼šè®¾ç½® Storage ç­–ç•¥

åœ¨ SQL Editor ä¸­æ‰§è¡Œ `scripts/fix-storage-policies.sql`ï¼š

```sql
-- åˆ é™¤æ—§ç­–ç•¥
DROP POLICY IF EXISTS "Public Access" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can upload" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can update" ON storage.objects;
DROP POLICY IF EXISTS "Authenticated users can delete" ON storage.objects;

-- åˆ›å»ºæ–°ç­–ç•¥
CREATE POLICY "gift_images_public_access"
ON storage.objects FOR SELECT
USING (bucket_id = 'gift-images');

CREATE POLICY "gift_images_authenticated_upload"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'gift-images');

CREATE POLICY "gift_images_authenticated_update"
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'gift-images')
WITH CHECK (bucket_id = 'gift-images');

CREATE POLICY "gift_images_authenticated_delete"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'gift-images');
```

### ç¬¬4æ­¥ï¼šé‡å¯å¼€å‘æœåŠ¡å™¨

åœ¨ç»ˆç«¯ä¸­ï¼š
```bash
# æŒ‰ Ctrl+C åœæ­¢å½“å‰æœåŠ¡å™¨
npm run dev
```

### ç¬¬5æ­¥ï¼šæµ‹è¯•åŠŸèƒ½

#### æµ‹è¯•1ï¼šæŸ¥çœ‹å•†å“åˆ—è¡¨
1. è®¿é—® http://localhost:3000/admin/gifts
2. åº”è¯¥çœ‹åˆ°1ä¸ªæµ‹è¯•å•†å“ âœ…

#### æµ‹è¯•2ï¼šåˆ›å»ºæ–°å•†å“
1. ç‚¹å‡»"æ·»åŠ å•†å“"
2. å¡«å†™ä¿¡æ¯ï¼š
   - ä¸­æ–‡åç§°ï¼šé‡‘è‰²ç«¥ä¹¦
   - è‹±æ–‡åç§°ï¼šLittle Golden Books
   - ä¸­æ–‡æè¿°ï¼šç»å…¸å„¿ç«¥è¯»ç‰©
   - è‹±æ–‡æè¿°ï¼šClassic children's books
   - é‡‘å¸ä»·æ ¼ï¼š1000
   - åº“å­˜ï¼š5
   - åˆ†ç±»ï¼šå®ç‰©å•†å“
3. ç‚¹å‡»"ä¸Šä¼ å›¾ç‰‡"ï¼Œé€‰æ‹©ä¸€å¼ å›¾ç‰‡
4. ç‚¹å‡»"åˆ›å»ºå•†å“"
5. åº”è¯¥æˆåŠŸ âœ…

#### æµ‹è¯•3ï¼šç¼–è¾‘å•†å“
1. ç‚¹å‡»ä»»æ„å•†å“çš„"ç¼–è¾‘"æŒ‰é’®
2. ä¿®æ”¹åº“å­˜æ•°é‡
3. ç‚¹å‡»"æ›´æ–°å•†å“"
4. åº”è¯¥æˆåŠŸ âœ…

#### æµ‹è¯•4ï¼šåˆ é™¤å•†å“
1. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
2. ç¡®è®¤åˆ é™¤
3. åº”è¯¥æˆåŠŸ âœ…

## ğŸ¯ éªŒè¯æ¸…å•

- [ ] Supabase ä¸­ gifts è¡¨å·²åˆ›å»º
- [ ] Supabase ä¸­ gift-images bucket å·²åˆ›å»º
- [ ] Storage ç­–ç•¥å·²è®¾ç½®
- [ ] å¼€å‘æœåŠ¡å™¨å·²é‡å¯
- [ ] å¯ä»¥æŸ¥çœ‹å•†å“åˆ—è¡¨
- [ ] å¯ä»¥ä¸Šä¼ å›¾ç‰‡
- [ ] å¯ä»¥åˆ›å»ºå•†å“
- [ ] å¯ä»¥ç¼–è¾‘å•†å“
- [ ] å¯ä»¥åˆ é™¤å•†å“

## ğŸ› å¦‚æœè¿˜æœ‰é—®é¢˜

### é—®é¢˜1ï¼šä»ç„¶æç¤º "Bucket not found"
**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ bucket åç§°æ˜¯å¦ä¸º `gift-images`
2. ç¡®è®¤ bucket çš„ Public é€‰é¡¹å·²å‹¾é€‰
3. åˆ·æ–°é¡µé¢é‡è¯•

### é—®é¢˜2ï¼šä»ç„¶æç¤º "invalid input syntax for type uuid"
**è§£å†³æ–¹æ³•ï¼š**
1. åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š
```sql
-- æ¸…ç†æ— æ•ˆæ•°æ®
UPDATE public.gifts
SET image_url = NULL
WHERE image_url = 'undefined' OR image_url = '';

UPDATE public.gifts
SET created_by = NULL
WHERE created_by::text = 'undefined';
```
2. é‡å¯æœåŠ¡å™¨
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Rï¼‰

### é—®é¢˜3ï¼š403 Forbidden é”™è¯¯
**è§£å†³æ–¹æ³•ï¼š**
1. ç¡®è®¤ä½ å·²ç™»å½•ç®¡ç†å‘˜è´¦å·
2. åœ¨ SQL Editor ä¸­æ£€æŸ¥ï¼š
```sql
SELECT id, email, is_admin 
FROM profiles 
WHERE id = auth.uid();
```
3. å¦‚æœ is_admin ä¸º falseï¼Œæ‰§è¡Œï¼š
```sql
UPDATE profiles 
SET is_admin = true 
WHERE email = 'ä½ çš„é‚®ç®±';
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `scripts/COMPLETE-FIX-GIFTS.sql` - å®Œæ•´ä¿®å¤è„šæœ¬
- `scripts/fix-storage-policies.sql` - Storage ç­–ç•¥è„šæœ¬
- `app/api/gifts/route.ts` - å•†å“åˆ—è¡¨ API
- `app/api/gifts/[id]/route.ts` - å•†å“è¯¦æƒ… API
- `app/api/gifts/upload/route.ts` - å›¾ç‰‡ä¸Šä¼  API
- `app/admin/gifts/page.tsx` - ç®¡ç†åå°é¡µé¢

## ğŸ‰ å®Œæˆ

æ‰§è¡Œå®Œæ‰€æœ‰æ­¥éª¤åï¼Œå•†å“ç³»ç»Ÿåº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œäº†ï¼

å¦‚æœè¿˜æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰
- ç»ˆç«¯æ—¥å¿—
- Supabase Dashboard â†’ Logs
